var ruleMap = {
	sudoku : {
		name : "数独",
		url : "https://www.nikoli.co.jp/ja/puzzles/sudoku/",
		source : "ニコリ公式"
	},
	shakashaka : {
		name : "シャカシャカ",
		url : "https://www.nikoli.co.jp/ja/puzzles/shakashaka/",
		source : "ニコリ公式"
	},
	nurimisaki : {
		name : "ぬりみさき",
		url : "https://www.nikoli.co.jp/ja/puzzles/nurimisaki/",
		source : "ニコリ公式"
	},
	gokigen : {
		name : "ごきげんななめ",
		url : "https://www.nikoli.co.jp/ja/puzzles/gokigen_naname/",
		source : "ニコリ公式"
	},
	creek : {
		name : "クリーク",
		url : "https://www.nikoli.co.jp/ja/puzzles/creek/",
		source : "ニコリ公式"
	},
	tasquare : {
		name : "たすくえあ",
		url : "https://www.nikoli.co.jp/ja/puzzles/tasukuea/",
		source : "ニコリ公式"
	},
	reflect : {
		name : "リフレクトリンク",
		url : "http://indi.s58.xrea.com/reflect/",
		source : "連続発破保管庫さん"
	},
	akari : {
		name : "美術館",
		url : "https://www.nikoli.co.jp/ja/puzzles/akari/",
		source : "ニコリ公式"
	},
	slither : {
		name : "スリザーリンク",
		url : "https://www.nikoli.co.jp/ja/puzzles/slitherlink/",
		source : "ニコリ公式"
	},
	tapa : {
		name : "Tapa",
		url : "http://indi.s58.xrea.com/tapa/",
		source : "連続発破保管庫さん"
	},
	sashigane : {
		name : "さしがね",
		url : "https://www.nikoli.co.jp/ja/puzzles/sashigane/",
		source : "ニコリ公式"
	},
	masyu : {
		name : "ましゅ",
		url : "https://www.nikoli.co.jp/ja/puzzles/masyu/",
		source : "ニコリ公式"
	},
	geradeweg : {
		name : "グラーデヴェグ",
		url : "",
		source : ""
	},
	bag : {
		name : "バッグ",
		url : "https://www.nikoli.co.jp/ja/puzzles/bag/",
		source : "ニコリ公式"
	},
	kurodoko : {
		name : "黒どこ",
		url : "https://www.nikoli.co.jp/ja/puzzles/where_is_black_cells/",
		source : "ニコリ公式"
	},
	barns : {
		name : "バーンズ",
		url : "http://indi.s58.xrea.com/barns/",
		source : "連続発破保管庫さん"
	},
	midloop : {
		name : "ミッドループ",
		url : "https://www.nikoli.co.jp/ja/puzzles/mid-loop/",
		source : "ニコリ公式"
	},
	sukoro : {
		name : "数コロ",
		url : "https://www.nikoli.co.jp/ja/puzzles/sukoro/",
		source : "ニコリ公式"
	},
	balance : {
		name : "バランスループ",
		url : "",
		source : ""
	},
	minarism : {
		name : "マイナリズム",
		url : "	http://indi.s58.xrea.com/minarism/",
		source : "連続発破保管庫さん"
	},
	box : {
		name : "ボックス",
		url : "",
		source : ""
	},
	kurotto : {
		name : "クロット",
		url : "https://www.nikoli.co.jp/ja/puzzles/kurotto/",
		source : "ニコリ公式"
	},
	tents : {
		name : "Tents",
		url : "",
		source : ""
	},
	walllogic : {
		name : "ウォールロジック",
		url : "https://ja.wikipedia.org/wiki/%E3%82%A6%E3%82%A9%E3%83%BC%E3%83%AB%E3%83%AD%E3%82%B8%E3%83%83%E3%82%AF",
		source : "Wikipedia"
	},
	nurikabe : {
		name : "ぬりかべ",
		url : "https://www.nikoli.co.jp/ja/puzzles/nurikabe/",
		source : "ニコリ公式"
	},
	simpleloop : {
		name : "シンプルループ",
		url : "",
		source : ""
	},
	yinyang : {
		name : "しろまるくろまる",
		url : "",
		source : ""
	},
	heyawake : {
		name : "へやわけ",
		url : "https://www.nikoli.co.jp/ja/puzzles/heyawake/",
		source : "ニコリ公式"
	},
	pipelink : {
		name : "パイプリンク",
		url : "https://www.nikoli.co.jp/ja/puzzles/pipe_link/",
		source : "ニコリ公式"
	},
	snake : {
		name : "Snake",
		url : "",
		source : ""
	},
	tatamibari : {
		name : "タタミバリ",
		url : "http://indi.s58.xrea.com/tatamibari/",
		source : "連続発破保管庫さん"
	},
	tateyoko : {
		name : "タテボーヨコボー",
		url : "http://indi.s58.xrea.com/tateyoko/",
		source : "連続発破保管庫さん"
	},
	building : {
		name : "ビルディングパズル",
		url : "https://ja.wikipedia.org/wiki/%E3%83%93%E3%83%AB%E3%83%87%E3%82%A3%E3%83%B3%E3%82%B0%E3%83%91%E3%82%BA%E3%83%AB",
		source : "Wikipedia"
	},
	yajikazu : {
		name : "やじさんかずさん",
		url : "https://www.nikoli.co.jp/ja/puzzles/yajisan_kazusan/",
		source : "ニコリ公式"
	},
	shugaku : {
		name : "修学旅行の夜",
		url : "http://indi.s58.xrea.com/shugaku/",
		source : "連続発破保管庫さん"
	},
	starbattle : {
		name : "スターバトル",
		url : "",
		source : ""
	},
	putteria : {
		name : "プッテリア",
		url : "",
		source : ""
	},
	norinori : {
		name : "のりのり",
		url : "https://www.nikoli.co.jp/ja/puzzles/norinori/",
		source : "ニコリ公式"
	},
	tentaisho : {
		name : "天体ショー",
		url : "https://www.nikoli.co.jp/ja/puzzles/astronomical_show/",
		source : "ニコリ公式"
	},
	yajilin : {
		name : "ヤジリン",
		url : "https://www.nikoli.co.jp/ja/puzzles/yajilin/",
		source : "ニコリ公式"
	},
	herugolf : {
		name : "ヘルゴルフ",
		url : "https://www.nikoli.co.jp/ja/puzzles/herugolf/",
		source : "ニコリ公式"
	},
	nanro : {
		name : "ナンロー",
		url : "",
		source : ""
	},
	hakoiri : {
		name : "はこいり○△□",
		url : "http://indi.s58.xrea.com/hakoiri/",
		source : "連続発破保管庫さん"
	},
	ripple : {
		name : "波及効果",
		url : "https://www.nikoli.co.jp/ja/puzzles/ripple_effect/",
		source : "ニコリ公式"
	},
	usoone : {
		name : "ウソワン",
		url : "https://www.nikoli.co.jp/ja/puzzles/usowan/",
		source : "ニコリ公式"
	},
	nurimaze : {
		name : "ぬりめいず",
		url : "https://www.nikoli.co.jp/ja/puzzles/nurimeizu/",
		source : "ニコリ公式"
	},
	tilepaint : {
		name : "タイルペイント",
		url : "https://www.nikoli.co.jp/ja/puzzles/tile_paint/",
		source : "ニコリ公式"
	},
	hitori : {
		name : "ひとりにしてくれ",
		url : "https://www.nikoli.co.jp/ja/puzzles/hitori/",
		source : "ニコリ公式"
	},
	moonsun : {
		name : "月か太陽",
		url : "https://www.nikoli.co.jp/ja/puzzles/moon-or-sun/",
		source : "ニコリ公式"
	},
	icebarn : {
		name : "アイスバーン",
		url : "http://indi.s58.xrea.com/icebarn/",
		source : "連続発破保管庫さん"
	},
	yajitatami : {
		name : "ヤジタタミ",
		url : "",
		source : ""
	},
	renban : {
		name : "連番窓口",
		url : "http://indi.s58.xrea.com/renban/",
		source : "連続発破保管庫さん"
	},
	country : {
		name : "カントリーロード",
		url : "https://www.nikoli.co.jp/ja/puzzles/country_road/",
		source : "ニコリ公式"
	},
	easyasabc : {
		name : "ABCプレース",
		url : "https://ja.wikipedia.org/wiki/ABC%E3%83%97%E3%83%AC%E3%83%BC%E3%82%B9",
		source : "Wikipedia"
	},
	mochikoro : {
		name : "モチコロ",
		url : "https://www.nikoli.co.jp/ja/puzzles/mochikoro/",
		source : "ニコリ公式"
	},
	mochinyoro : {
		name : "モチにょろ",
		url : "http://indi.s58.xrea.com/mochinyoro/",
		source : "連続発破保管庫さん"
	},
	scrin : {
		name : "スクリン",
		url : "",
		source : ""
	},
	meander : {
		name : "にょろにょろナンバー",
		url : "",
		source : ""
	},
	doppelblock : {
		name : "Doppelblock",
		url : "",
		source : ""
	},
	fillmat : {
		name : "フィルマット",
		url : "https://www.nikoli.co.jp/ja/puzzles/fillmat/",
		source : "ニコリ公式"
	},
	cojun : {
		name : "コージュン",
		url : "http://indi.s58.xrea.com/cojun/",
		source : "連続発破保管庫さん"
	},
	mines : {
		name : "マインスイーパ",
		url : "",
		source : ""
	},
	sukororoom : {
		name : "数コロ部屋",
		url : "",
		source : ""
	},
	simplegako : {
		name : "シンプルガコ",
		url : "",
		source : ""
	},
	nonogram : {
		name : "ののぐらむ",
		url : "https://ja.wikipedia.org/wiki/%E3%81%8A%E7%B5%B5%E3%81%8B%E3%81%8D%E3%83%AD%E3%82%B8%E3%83%83%E3%82%AF",
		source : "Wikipedia"
	},
	aqre : {
		name : "Aqre",
		url : "",
		source : ""
	},
	fillomino : {
		name : "フィルオミノ",
		url : "https://www.nikoli.co.jp/ja/puzzles/fillomino/",
		source : "ニコリ公式"
	},
	lookair : {
		name : "るっくえあ",
		url : "",
		source : ""
	},
	nibunnogo : {
		name : "ニブンノゴ",
		url : "",
		source : ""
	},
	las : {
		name : "Light and Shadow",
		url : "",
		source : ""
	},
	whitelink : {
		name : "ホワイトリンク",
		url : "",
		source : ""
	},
	wafusuma : {
		name : "和フスマ",
		url : "",
		source : ""
	},
	gaps : {
		name : "Gaps",
		url : "",
		source : ""
	},
	clouds : {
		name : "Clouds",
		url : "",
		source : ""
	},
	canal : {
		name : "Canal View",
		url : "",
		source : ""
	},
	archipelago : {
		name : "アーキペラゴ",
		url : "",
		source : ""
	},
	hoshizora : {
		name : "星空めぐり",
		url : "",
		source : ""
	},
	sukima : {
		name : "スキマあつめ",
		url : "",
		source : ""
	},
	hurdle : {
		name : "ハードル",
		url : "",
		source : ""
	},
	nuribou : {
		name : "ぬりぼう",
		url : "http://indi.s58.xrea.com/nuribou/",
		source : "連続発破保管庫さん"
	},
	norinuri : {
		name : "海苔ぬり",
		url : "",
		source : ""
	},
	nurisan : {
		name : "ぬりさん",
		url : "",
		source : ""
	},
	cocktail : {
		name : "カクテルランプ",
		url : "",
		source : ""
	},
	sbl : {
		name : "Square-block Loop",
		url : "",
		source : ""
	},
	dominofield : {
		name : "ドミノフィールド",
		url : "",
		source : ""
	},
	voxas : {
		name : "Voxas",
		url : "https://pzprxs.vercel.app/rules.html?voxas",
		source : "pzprxsさん"
	},
	tajmahal : {
		name : "タージ・マハル",
		url : "https://pzprxs.vercel.app/rules.html?tajmahal",
		source : "pzprxsさん"
	},
}
var regMap = {
		yajilin:[{type:'yajilin',size:10},{type:'yajilin',size:10},{type:'yajilin',size:10},{type:'yajilin',size:10},{type:'yajilin',size:10},
			{type:'yajilin',size:10},{type:'yajilin',size:10},{type:'yajilin',size:10},{type:'yajilin',size:10},{type:'yajilin',size:10}],
		herugolf:[{type:'herugolf',size:10},{type:'herugolf',size:10},{type:'herugolf',size:10},{type:'herugolf',size:10},{type:'herugolf',size:10},
			{type:'herugolf',size:10},{type:'herugolf',size:10},{type:'herugolf',size:10},{type:'herugolf',size:10},{type:'herugolf',size:10}],
		nurimisaki:[{type:'nurimisaki',size:10},{type:'nurimisaki',size:10},{type:'nurimisaki',size:10},{type:'nurimisaki',size:10},{type:'nurimisaki',size:10},
			{type:'nurimisaki',size:10},{type:'nurimisaki',size:10},{type:'nurimisaki',size:10},{type:'nurimisaki',size:10},{type:'nurimisaki',size:10}],
		allloop:[{type:'geradeweg',size:10},{type:'simpleloop',size:10},{type:'slither',size:10},{type:'barns',size:10},{type:'pipelink',size:10},
			{type:'bag',size:10},{type:'masyu',size:10},{type:'midloop',size:10},{type:'yajilin',size:10},{type:'reflect',size:10}],
		shakashaka:[{type:'shakashaka',size:10},{type:'shakashaka',size:10},{type:'shakashaka',size:10},{type:'shakashaka',size:10},{type:'shakashaka',size:10},
			{type:'shakashaka',size:10},{type:'shakashaka',size:10},{type:'shakashaka',size:10},{type:'shakashaka',size:10},{type:'shakashaka',size:10}],
		yajitatami:[{type:'yajitatami',size:10},{type:'yajitatami',size:10},{type:'yajitatami',size:10},{type:'yajitatami',size:10},{type:'yajitatami',size:10},
			{type:'yajitatami',size:10},{type:'yajitatami',size:10},{type:'yajitatami',size:10},{type:'yajitatami',size:10},{type:'yajitatami',size:10}],
		icebarn:[{type:'icebarn',size:8},{type:'icebarn',size:8},{type:'icebarn',size:8},{type:'icebarn',size:8},{type:'icebarn',size:8},
			{type:'icebarn',size:8},{type:'icebarn',size:8},{type:'icebarn',size:8},{type:'icebarn',size:8},{type:'icebarn',size:8}],
}
var penpaEditUrlBase = 'https://opt-pan.github.io/penpa-edit/?m=solve';
var penpaEditDummyUrl = "penpa-edit-dummy-url";

var option = {
	size_3 : '<option value="3">3 x 3</option>',
	size_4 : '<option value="4">4 x 4</option>',
	size_5 : '<option value="5">5 x 5</option>',
	size_6 : '<option value="6">6 x 6</option>',
	size_7 : '<option value="7">7 x 7</option>',
	size_8 : '<option value="8">8 x 8</option>',
	size_9 : '<option value="9">9 x 9</option>',
	size_10 : '<option value="10">10 x 10</option>',
	size_11 : '<option value="11">11 x 11</option>',
	size_12 : '<option value="12">12 x 12</option>',
	size_15 : '<option value="15">15 x 15</option>',
	pattern_0 : '<option value="0">フリー</option>',
	pattern_1 : '<option value="1">点対称</option>',
	pattern_2 : '<option value="2">左右対称</option>',
	pattern_3 : '<option value="3">上下対称</option>',
	pattern_4 : '<option value="4">＼対称</option>',
	pattern_5 : '<option value="5">／対称</option>',
	pattern_6 : '<option value="6">上下左右対称</option>',
	pattern_7 : '<option value="7">卍型</option>',
}

// ハッシュタグに使えない文字
// 全てを網羅するのは難しいのでとりあえず使用頻度が高そうなもの
var hashtag_cannot = ['[',']',' ','=','-','+','*','/','＝','－','＋','×','÷','!','?','　','！','？',',','.','、','。','(',')','（','）','%','％'];

$(function() {
	// コース情報。オリコモードの場合は値が設定される。
	var courseInfo = {};

	// コースモードかどうかの判定
	var isCourseMode = function () {
		return Object.keys(courseInfo).length;
	}

	var toHashTag = function(str){
		for(var i=0;i< hashtag_cannot.length;i++){
			str=str.split(hashtag_cannot[i]).join('');
		}
		return str;
	}

	var getTime = function() {
		// 先頭ゼロ付加
		var padZero = function(num) {
			var result;
			if (num < 10) {
				result = "0" + num;
			} else {
				result = "" + num;
			}
			return result;
		}
		var now = new Date();
		var time = "" + now.getFullYear() + "/" + padZero(now.getMonth() + 1)
				+ "/" + padZero(now.getDate()) + " " + padZero(now.getHours())
				+ ":" + padZero(now.getMinutes()) + ":"
				+ padZero(now.getSeconds());
		return time;
	}

	var zipEncode = function(str){
        var u8text = new TextEncoder().encode(str);
        var deflate = new Zlib.RawDeflate(u8text);
        var compressed = deflate.compress();
        var char8 = Array.from(compressed, e => String.fromCharCode(e)).join("");
        var ba = window.btoa(char8);
        return ba;
	}
	
	$('#btn_clear').on('click', function(event) {
		if (window.confirm('履歴をクリアします。よろしいですか？')) {
			localStorage.setItem('history', JSON.stringify([]));
			showGrid();
		}
	});

	$('#btn_submit').on(
			'click',
			function(event) {
				if ($('#caption').text() == '抽選中です。少々お待ちください……') {
					// TODO 強引か…？
					return;
				}
				var time = getTime();
				$('#tweetbtn').hide();
				$('#edt_if').hide();
				$('#div_result').text('');
				$('#div_link').text('');
				$('#caption').text('抽選中です。少々お待ちください……');
				$('#loading').show();
				$('#sel_mode').prop("disabled", true);
				$('#sel_type').prop("disabled", true);
				$('#sel_size').prop("disabled", true);
				$('#sel_pattern').prop("disabled", true);
				var param = {};
				param.type = $('#sel_type').val();
				param.pattern = $('#sel_pattern').val();
				param.size = $('#sel_size').val();
				param.height = $('#sel_size').val();
				param.width = $('#sel_size').val();
				// 条件をローカルストレージ保存
				var cond = localStorage.getItem('condsudoku');
				var condObj = JSON.parse(cond);
				if (condObj != null) {
					condObj.mode = $('#sel_mode').val();
					condObj.type = param.type;
					condObj.pattern = param.pattern;
					condObj.size = param.size;
				} else {
					condObj = {
							mode : $('#sel_mode').val(),
							type : param.type,
							pattern : param.pattern,
							size : param.size,
					};
				}
				cond = JSON.stringify(condObj);
				localStorage.setItem('condsudoku', cond);
				$.ajax({
					url : 'SudokuGacha',
					type : 'POST',
					dataType : 'text',
					data : param
				}).done(
						function(result) {
							var resultObj = JSON.parse(result);
							$('#caption').text(resultObj.status);
							$('#loading').hide();
							$('#sel_mode').prop("disabled", false);
							$('#sel_type').prop("disabled", false);
							$('#sel_size').prop("disabled", false);
							$('#sel_pattern').prop("disabled", false);
							if (resultObj.result != '') {
								$('#div_result').html(resultObj.result);
								if (resultObj.fieldStr !== undefined){
									// penpa-edit対応
									var fieldStr = zipEncode(resultObj.fieldStr);
									var solutionStr = zipEncode(resultObj.solutionStr);
									resultObj.url = penpaEditUrlBase + '&p=' + fieldStr + '&a=' + solutionStr;
									resultObj.link = resultObj.link.replace(penpaEditDummyUrl, resultObj.url);
								}
								$('#div_link').html(resultObj.link);
								var tweetTxt = $(
										'#sel_type option[value=' + param.type
												+ ']').text()
										+ 'でLv'
										+ resultObj.level
										+ 'の問題を獲得！ '
										+ resultObj.url;
								var befSplitted = $('#tweetbtn').attr('href').split("?");
								var splitted = befSplitted[1].split("&");
								if (befSplitted.length == 3){
									befSplitted.splice(2,1);
								}
								splitted[0] = 'hashtags=ペンパガチャ';
								splitted[1] = 'text='
										+ encodeURIComponent(tweetTxt);
								splitted[3] = 'url=https%3a%2f%2ft%2eco%2fGg5hFCjLwP';
								befSplitted[1] = splitted.join('&')
								$('#tweetbtn').attr('href', befSplitted.join('?'))
								$('#tweetbtn').show();
								if (resultObj.txt) {
									$('#edt_if').val(resultObj.txt);
									$('#edt_if').show();
								}
								updateHistory(time, param.type, param.size, resultObj);
								showGrid();
							}
						}).fail(function() {
					$('#caption').text('通信時にエラーが発生しました');
					$('#loading').hide();
					$('#sel_mode').prop("disabled", false);
					$('#sel_type').prop("disabled", false);
					$('#sel_size').prop("disabled", false);
					$('#sel_pattern').prop("disabled", false);
				});
			});
	var resultList = [];
	var linkList = [];
	var levelList = [];
	var rtaGridInfo = [];
	var nowIndex = 0;
	$('#btn_submit_rta').on('click', function(event) {
		if ($('#caption').text().indexOf('抽選中です。少々お待ちください……') != -1) {
			// TODO 強引か…？
			return;
		}
		// すでに抽選後の問題を削除
		linkList.splice(0)
		resultList.splice(0)
		levelList.splice(0)
		initRtaGridInfo();
		showRtaGrid();
		$('#tweetbtn').hide();
		$('#edt_if').hide();
		$('#div_result').text('');
		$('#div_link').text('');
		$('#btn_start_rta').hide();
		$('#btn_next_rta').hide();
		$('#btn_rta_clear').hide();
		$('#sel_mode').prop("disabled", true);
		$('#sel_reg').prop("disabled", true);
		var regulations = regMap[$('#sel_reg').val()];
		if (isCourseMode()){
			regulations = courseInfo.course;
		} else {
			// 条件をローカルストレージ保存
			var cond = localStorage.getItem('condsudoku');
			var condObj = JSON.parse(cond);
			if (condObj != null) {
				condObj.mode = $('#sel_mode').val();
				condObj.reg = $('#sel_reg').val();
			} else {
				condObj = {
						mode : $('#sel_mode').val(),
						reg : $('#sel_reg').val(),
				};
			}
			cond = JSON.stringify(condObj);
			localStorage.setItem('condsudoku', cond);
		}
		var startSubmit = function(cnt) {
			$('#loading').show();
			if (cnt == regulations.length) {
				$('#caption').text('抽選完了。←のボタンを押すと開始します。');
				$('#loading').hide();
				$('#sel_mode').prop("disabled", false);
				$('#sel_reg').prop("disabled", false);
				$('#btn_submit_rta').hide();
				$('#btn_start_rta').show();
			} else {
				$('#caption').text('抽選中です。少々お待ちください……' + cnt + '/' + regulations.length);
				var param = {};
				param.type = regulations[cnt].type;
				param.pattern = 0;
				param.size = regulations[cnt].size;
				param.height = regulations[cnt].size;
				param.width = regulations[cnt].size;
				$.ajax({
					url : 'SudokuGacha',
					type : 'POST',
					dataType : 'text',
					data : param
				}).done(function(result) {
					var resultObj = JSON.parse(result);
					if (resultObj.status.indexOf('申し訳ありません') != -1 ){
						// 抽選できてなかったらもう一回
						startSubmit(cnt);
					} else {
						if (resultObj.fieldStr !== undefined){
							// penpa-edit対応
							var fieldStr = zipEncode(resultObj.fieldStr);
							var solutionStr = zipEncode(resultObj.solutionStr);
							resultObj.url = penpaEditUrlBase + '&p=' + fieldStr + '&a=' + solutionStr;
							resultObj.link = resultObj.link.replace(penpaEditDummyUrl, resultObj.url);
						}
						resultList.push(resultObj.result);
						linkList.push(resultObj.link);
						levelList.push(resultObj.level);
						startSubmit(++cnt);
					}
				}).fail(function() {
					$('#caption').text('通信時にエラーが発生しました');
					$('#loading').hide();
					$('#sel_mode').prop("disabled", false);
					$('#sel_reg').prop("disabled", false);
				});
			}
		};
		startSubmit(0);
	});
	var firstTime;
	var befTime;
	$('#btn_start_rta').on('click', function(event) {
		nowIndex = 0;
		$('#div_result').html(resultList[nowIndex]);
		$('#div_link').html(linkList[nowIndex]);
		$('#caption').text((nowIndex+1) + "問目：" + rtaGridInfo[nowIndex].type +  "：Lv" + levelList[nowIndex]);
		$('#btn_start_rta').hide();
		$('#btn_next_rta').show();
		$('#btn_next_rta').prop("disabled", true);
		$('#btn_rta_clear').show();
		$('#lbl_rta_status').text("");
		rtaGridInfo[nowIndex].level = levelList[nowIndex];
		var now = new Date().getTime();
		firstTime = now;
		befTime = now;
		showRtaGrid();
	});
	$('body').on('click', '#div_link a', function(event) {
		$('#btn_next_rta').prop("disabled", false);
	});
	$('#btn_next_rta').on('click', function(event) {
		var now = new Date().getTime();
		rtaGridInfo[nowIndex].link = linkList[nowIndex].replace('puzz\.linkで', '').replace('ぱずぷれv3で','').replace('pzprxsで','').replace('penpa-editで','');
		rtaGridInfo[nowIndex].time = ((now - befTime) / 1000).toFixed(3);
		rtaGridInfo[nowIndex].totaltime = ((now - firstTime) / 1000).toFixed(3);
		if (nowIndex == rtaGridInfo.length - 1) {
			$('#lbl_rta_status').text("完走済");
			showRtaGrid();
			var totalTime = rtaGridInfo[nowIndex].totaltime;
			var minute = Math.floor(totalTime / 60);
			var second = Math.floor(totalTime % 60);
			var decimal = totalTime.split('.')[1];
			var resultStr = minute + '分' + second + '秒' + decimal;
			$('#caption').text(resultStr + 'で完走！お疲れさまでした！');
			var coursename = $('#sel_reg option[value=' + $('#sel_reg').val() + ']').text();
			if (isCourseMode()){
				coursename = courseInfo.name;
			}
			var tweetTxt =
					coursename
					+ 'を'
					+ resultStr
					+ 'で完走しました！'
			var befSplitted = $('#tweetbtn').attr('href').split("?");
			var splitted = befSplitted[1].split("&");
			if (befSplitted.length == 3){
				befSplitted.splice(2,1);
			}
			splitted[0] = 'hashtags=ペンパガチャ,'
				+ encodeURIComponent(toHashTag(coursename) + 'RTA');
			splitted[1] = 'text='
					+ encodeURIComponent(tweetTxt);
			if (isCourseMode()){
				splitted[3] = 'url=' + encodeURIComponent(location.href);
			} else {
				splitted[3] = 'url=' + 'https%3a%2f%2ft%2eco%2fGg5hFCjLwP';
			}
			befSplitted[1] = splitted.join('&')
			$('#tweetbtn').attr('href', befSplitted.join('?'))
			$('#tweetbtn').show();
			$('#div_result').html('');
			$('#div_link').html('');
			$('#btn_next_rta').hide();
		} else {
			nowIndex++;
			$('#lbl_rta_status').text(nowIndex + "問目まで解答完了");
			$('#div_result').html(resultList[nowIndex]);
			$('#div_link').html(linkList[nowIndex]);
			$('#caption').text((nowIndex+1) + "問目：" + rtaGridInfo[nowIndex].type +  "：Lv" + levelList[nowIndex]);
			$('#btn_next_rta').prop("disabled", true);
			rtaGridInfo[nowIndex].level = levelList[nowIndex];
			befTime = now;
			showRtaGrid();
		}
	});
	$('#btn_rta_clear').on('click', function(event) {
		if (window.confirm('リセットします。よろしいですか？')) {
			showhide();
		}
	});
	$('#sel_type').change(function() {
		showhide();
	});
	$('#sel_reg').change(function() {
		showhide();
	});
	$('#sel_mode').change(function() {
		showhide();
		if ($('#sel_mode').val() != 'course'){
			initCourseGridInfo();
			showCourseGrid();
		}
	});
	var showhide = function() {
		if (isCourseMode()){
			$('#div_title').html(courseInfo.name);
			$('#lbl_mode').hide();
			$('#sel_mode').hide();
			$('#lbl_type').hide();
			$('#sel_type').hide();
			$('#lbl_reg').hide();
			$('#sel_reg').hide();
			$('#lbl_size').hide();
			$('#sel_size').hide();
			$('#lbl_pattern').hide();
			$('#sel_pattern').hide();
			$('#btn_submit').hide();
			$('#btn_submit_rta').show();
			$('#btn_submit_course').hide();
			$('#btn_start_rta').hide();
			$('#btn_next_rta').hide();
			$('#lbl_history').hide();
			$('#btn_clear').hide();
			$('#lbl_rta_history').show();
			$('#lbl_rta_status').show();
			$('#btn_rta_clear').hide();
			$('#lbl_course_name').hide();
			$('#edt_course_name').hide();
			$('#btn_course_finish').hide();
			$('#grid').hide();
			$('#grid_rta').show();
			$('#grid_course').hide();
			$('#tweetbtn').hide();
			$('#edt_if').hide();
			$('#caption').text('');
			$('#div_result').text('');
			$('#div_link').text('');
			$('#loading').hide();
			initRtaGridInfo();
			showRtaGrid();
			$('#div_rule').hide();
			$('#lbl_course_already').hide();
			$('#a_course').hide();
			return;
		}
		var mode = $('#sel_mode').val();
		if (mode == 'normal') {
			var type = $('#sel_type').val();
			$('#lbl_type').show();
			$('#sel_type').show();
			$('#lbl_reg').hide();
			$('#sel_reg').hide();
			$('#lbl_size').show();
			$('#sel_size').show();
			if (type == 'sudoku' || type == 'akari' || type == 'slither'
				|| type == 'creek' || type == 'gokigen' || type == 'tapa'
				|| type == 'bag' || type == 'kurodoko' || type == 'sukoro'
				|| type == 'walllogic' || type == 'tateyoko') {
				$('#lbl_pattern').show();
				$('#sel_pattern').show();
			} else {
				$('#lbl_pattern').hide();
				$('#sel_pattern').hide();
			}
			$('#btn_submit').show();
			$('#btn_submit_rta').hide();
			$('#btn_submit_course').hide();
			$('#btn_start_rta').hide();
			$('#btn_next_rta').hide();
			$('#lbl_history').show();
			$('#btn_clear').show();
			$('#lbl_rta_history').hide();
			$('#lbl_rta_status').hide();
			$('#btn_rta_clear').hide();
			$('#lbl_course_name').hide();
			$('#edt_course_name').hide();
			$('#btn_course_finish').hide();
			$('#grid').show();
			$('#grid_rta').hide();
			$('#grid_course').hide();
			$('#tweetbtn').hide();
			$('#edt_if').hide();
			$('#caption').text('');
			$('#div_result').text('');
			$('#div_link').text('');
			$('#loading').hide();
			var oneRule = ruleMap[type];
			if (oneRule.url != '') {
				$('#a_rule').attr('href', oneRule.url)
				$('#a_rule').text(
						oneRule.name + 'のルールを表示(' + oneRule.source + ')')
				$('#div_rule').show();
			} else {
				$('#div_rule').hide();
			}
			$('#lbl_course_already').hide();
			$('#a_course').hide();
		} else if (mode == 'rta') {
			$('#lbl_type').hide();
			$('#sel_type').hide();
			$('#lbl_reg').show();
			$('#sel_reg').show();
			$('#lbl_size').hide();
			$('#sel_size').hide();
			$('#lbl_pattern').hide();
			$('#sel_pattern').hide();
			$('#btn_submit').hide();
			$('#btn_submit_rta').show();
			$('#btn_submit_course').hide();
			$('#btn_start_rta').hide();
			$('#btn_next_rta').hide();
			$('#lbl_history').hide();
			$('#btn_clear').hide();
			$('#lbl_rta_history').show();
			$('#lbl_rta_status').show();
			$('#btn_rta_clear').hide();
			$('#lbl_course_name').hide();
			$('#edt_course_name').hide();
			$('#btn_course_finish').hide();
			$('#grid').hide();
			$('#grid_rta').show();
			$('#grid_course').hide();
			$('#tweetbtn').hide();
			$('#edt_if').hide();
			$('#caption').text('');
			$('#div_result').text('');
			$('#div_link').text('');
			$('#loading').hide();
			initRtaGridInfo();
			showRtaGrid();
			$('#div_rule').hide();
			$('#lbl_course_already').hide();
			$('#a_course').hide();
		} else if (mode == 'course') {
			$('#lbl_type').show();
			$('#sel_type').show();
			$('#lbl_reg').hide();
			$('#sel_reg').hide();
			$('#lbl_size').show();
			$('#sel_size').show();
			$('#lbl_pattern').hide();
			$('#sel_pattern').hide();
			$('#btn_submit').hide();
			$('#btn_submit_rta').hide();
			$('#btn_submit_course').show();
			$('#btn_start_rta').hide();
			$('#btn_next_rta').hide();
			$('#lbl_history').hide();
			$('#btn_clear').hide();
			$('#lbl_rta_history').hide();
			$('#lbl_rta_status').hide();
			$('#btn_rta_clear').hide();
			$('#lbl_course_name').show();
			$('#edt_course_name').show();
			$('#btn_course_finish').show();
			$('#grid').hide();
			$('#grid_rta').hide();
			$('#grid_course').show();
			$('#tweetbtn').hide();
			$('#edt_if').hide();
			$('#caption').text('');
			$('#div_result').text('');
			$('#div_link').text('');
			$('#loading').hide();
			$('#div_rule').hide();
			$('#lbl_course_already').hide();
			$('#a_course').hide();
		}
		if (mode == 'normal' || mode == 'course') {
			var type = $('#sel_type').val();
			// この辺の書き方がいかにもJQuery的で古くさい…モダンFW使いたい…
			var nowSelSizeVal = $('#sel_size').val();
			$('#sel_size').empty();
			if (type == 'sudoku') {
				$('#sel_size').append(option.size_4);
				$('#sel_size').append(option.size_6);
				$('#sel_size').append(option.size_9);
				if (nowSelSizeVal < 6) {
					$('#sel_size').val(4);
				} else if (nowSelSizeVal < 9) {
					$('#sel_size').val(6);
				} else {
					$('#sel_size').val(9);
				}
			} else if (type == 'wafusuma') {
				$('#sel_size').append(option.size_3);
				$('#sel_size').append(option.size_4);
				$('#sel_size').append(option.size_5);
				if (nowSelSizeVal > 5) {
					$('#sel_size').val(5);
				} else {
					$('#sel_size').val(nowSelSizeVal);
				}
			} else if (type == 'building' || type == 'renban'
				|| type == 'easyasabc' || type == 'doppelblock' || type == 'simplegako' || type == 'archipelago' ) {
				$('#sel_size').append(option.size_3);
				$('#sel_size').append(option.size_4);
				$('#sel_size').append(option.size_5);
				$('#sel_size').append(option.size_6);
				if (nowSelSizeVal > 6) {
					$('#sel_size').val(6);
				} else {
					$('#sel_size').val(nowSelSizeVal);
				}
			} else if (type == 'minarism' || type == 'sbl') {
				$('#sel_size').append(option.size_3);
				$('#sel_size').append(option.size_4);
				$('#sel_size').append(option.size_5);
				$('#sel_size').append(option.size_6);
				$('#sel_size').append(option.size_7);
				if (nowSelSizeVal > 7) {
					$('#sel_size').val(7);
				} else {
					$('#sel_size').val(nowSelSizeVal);
				}
			} else if (type == 'balance' || type == 'kurotto'
					|| type == 'nurikabe' || type == 'heyawake'
					|| type == 'shugaku' || type == 'icebarn'
					|| type == 'country' || type == 'meander'
					|| type == 'fillmat' || type == 'aqre'
					|| type == 'fillomino' || type == 'lookair'
					|| type == 'las' || type == 'norinuri' 
					|| type == 'nurisan' || type == 'cocktail' || type == 'voxas') {
				$('#sel_size').append(option.size_3);
				$('#sel_size').append(option.size_4);
				$('#sel_size').append(option.size_5);
				$('#sel_size').append(option.size_6);
				$('#sel_size').append(option.size_7);
				$('#sel_size').append(option.size_8);
				if (nowSelSizeVal > 8) {
					$('#sel_size').val(8);
				} else {
					$('#sel_size').val(nowSelSizeVal);
				}
			} else if (type == 'box') {
				$('#sel_size').append(option.size_3);
				$('#sel_size').append(option.size_4);
				$('#sel_size').append(option.size_5);
				$('#sel_size').append(option.size_6);
				$('#sel_size').append(option.size_7);
				$('#sel_size').append(option.size_8);
				$('#sel_size').append(option.size_9);
				if (nowSelSizeVal > 9) {
					$('#sel_size').val(9);
				} else {
					$('#sel_size').val(nowSelSizeVal);
				}
			} else if (type == 'sashigane' || type == 'barns'
					|| type == 'pipelink' || type == 'scrin') {
				$('#sel_size').append(option.size_4);
				$('#sel_size').append(option.size_5);
				$('#sel_size').append(option.size_6);
				$('#sel_size').append(option.size_7);
				$('#sel_size').append(option.size_8);
				$('#sel_size').append(option.size_9);
				$('#sel_size').append(option.size_10);
				if (nowSelSizeVal == 3) {
					$('#sel_size').val(4);
				} else if (nowSelSizeVal > 10) {
					$('#sel_size').val(10);
				} else {
					$('#sel_size').val(nowSelSizeVal);
				}
			} else if (type == 'norinori') {
				$('#sel_size').append(option.size_4);
				$('#sel_size').append(option.size_5);
				$('#sel_size').append(option.size_6);
				$('#sel_size').append(option.size_7);
				$('#sel_size').append(option.size_8);
				if (nowSelSizeVal == 3) {
					$('#sel_size').val(4);
				} else if (nowSelSizeVal > 8) {
					$('#sel_size').val(8);
				} else {
					$('#sel_size').val(nowSelSizeVal);
				}
			} else if (type == 'starbattle') {
				$('#sel_size').append(option.size_5);
				$('#sel_size').append(option.size_9);
				if (nowSelSizeVal == 3 || nowSelSizeVal == 4) {
					$('#sel_size').val(5);
				} else if (nowSelSizeVal == 6 || nowSelSizeVal == 7
						|| nowSelSizeVal == 8) {
					$('#sel_size').val(5);
				} else if (nowSelSizeVal > 9) {
					$('#sel_size').val(9);
				} else {
					$('#sel_size').val(nowSelSizeVal);
				}
			} else if (type == 'hurdle') {
				$('#sel_size').append(option.size_4);
				$('#sel_size').append(option.size_6);
				$('#sel_size').append(option.size_8);
				if (nowSelSizeVal == 3 || nowSelSizeVal == 5) {
					$('#sel_size').val(4);
				} else if (nowSelSizeVal == 7) {
					$('#sel_size').val(6);
				} else if (nowSelSizeVal > 8) {
					$('#sel_size').val(8);
				} else {
					$('#sel_size').val(nowSelSizeVal);
				}
			} else if (type == 'hoshizora') {
				$('#sel_size').append(option.size_4);
				$('#sel_size').append(option.size_6);
				$('#sel_size').append(option.size_8);
				$('#sel_size').append(option.size_10);
				$('#sel_size').append(option.size_12);
				if (nowSelSizeVal == 3 || nowSelSizeVal == 5) {
					$('#sel_size').val(4);
				} else if (nowSelSizeVal == 7) {
					$('#sel_size').val(6);
				} else if (nowSelSizeVal == 9) {
					$('#sel_size').val(8);
				} else if (nowSelSizeVal == 11) {
					$('#sel_size').val(10);
				} else if (nowSelSizeVal > 12) {
					$('#sel_size').val(12);
				} else {
					$('#sel_size').val(nowSelSizeVal);
				}
			} else if (type == 'gaps') {
				$('#sel_size').append(option.size_9);
				$('#sel_size').append(option.size_10);
				$('#sel_size').append(option.size_11);
				$('#sel_size').append(option.size_12);
				if (nowSelSizeVal < 9) {
					$('#sel_size').val(9);
				} else if (nowSelSizeVal > 12) {
					$('#sel_size').val(12);
				} else {
					$('#sel_size').val(nowSelSizeVal);
				}
			} else if (type == 'tilepaint' || type == 'mines' || type == 'nonogram' || type == 'dominofield') {
				$('#sel_size').append(option.size_3);
				$('#sel_size').append(option.size_4);
				$('#sel_size').append(option.size_5);
				$('#sel_size').append(option.size_6);
				$('#sel_size').append(option.size_7);
				$('#sel_size').append(option.size_8);
				$('#sel_size').append(option.size_9);
				$('#sel_size').append(option.size_10);
				$('#sel_size').append(option.size_12);
				$('#sel_size').append(option.size_15);
				if (nowSelSizeVal == 11) {
					$('#sel_size').val(10);
				} else {
					$('#sel_size').val(nowSelSizeVal);
				}
			} else {
				$('#sel_size').append(option.size_3);
				$('#sel_size').append(option.size_4);
				$('#sel_size').append(option.size_5);
				$('#sel_size').append(option.size_6);
				$('#sel_size').append(option.size_7);
				$('#sel_size').append(option.size_8);
				$('#sel_size').append(option.size_9);
				$('#sel_size').append(option.size_10);
				if (nowSelSizeVal > 10) {
					$('#sel_size').val(10);
				} else {
					$('#sel_size').val(nowSelSizeVal);
				}
			}
			var nowSelPetternVal = $('#sel_pattern').val();
			$('#sel_pattern').empty();
			if (type == 'tapa' || type == 'bag') {
				$('#sel_pattern').append(option.pattern_0);
				$('#sel_pattern').append(option.pattern_1);
				$('#sel_pattern').append(option.pattern_2);
				$('#sel_pattern').append(option.pattern_3);
				$('#sel_pattern').append(option.pattern_4);
				$('#sel_pattern').append(option.pattern_5);
				if (nowSelPetternVal == 6) {
					$('#sel_pattern').val(2);
				} else if (nowSelPetternVal == 7) {
					$('#sel_pattern').val(1);
				} else {
					$('#sel_pattern').val(nowSelPetternVal);
				}
			} else if (type == 'sukoro') {
				$('#sel_pattern').append(option.pattern_0);
				if (nowSelSizeVal <= 8) {
					$('#sel_pattern').append(option.pattern_1);
					$('#sel_pattern').append(option.pattern_2);
					$('#sel_pattern').append(option.pattern_3);
					$('#sel_pattern').append(option.pattern_4);
					$('#sel_pattern').append(option.pattern_5);
					if (nowSelPetternVal == 6) {
						$('#sel_pattern').val(2);
					} else if (nowSelPetternVal == 7) {
						$('#sel_pattern').val(1);
					} else {
						$('#sel_pattern').val(nowSelPetternVal);
					}
				} else {
					$('#sel_pattern').val(0);
				}
			} else {
				$('#sel_pattern').append(option.pattern_0);
				$('#sel_pattern').append(option.pattern_1);
				$('#sel_pattern').append(option.pattern_2);
				$('#sel_pattern').append(option.pattern_3);
				$('#sel_pattern').append(option.pattern_4);
				$('#sel_pattern').append(option.pattern_5);
				$('#sel_pattern').append(option.pattern_6);
				$('#sel_pattern').append(option.pattern_7);
				$('#sel_pattern').val(nowSelPetternVal);
			}
		}
	}
	var updateHistory = function(time, type, size, resultObj) {
		var history = localStorage.getItem('history');
		var historyObj = JSON.parse(history);
		if (historyObj == null) {
			historyObj = [];
		}
		historyObj.unshift({
			time : time,
			type : ruleMap[type].name + '(' + size + ')',
			level : resultObj.level,
			// TODO むりやり…
			link : resultObj.link.replace('(波及効果バリアント)', '').replace('puzz\.linkで', '').replace('ぱずぷれv3で',
					'').replace('pzprxsで','').replace('penpa-editで',''),
		});
		if (historyObj.length > 20) {
			historyObj.pop();
		}
		localStorage.setItem('history', JSON.stringify(historyObj));

	}
	var showGrid = function() {
		var history = localStorage.getItem('history');
		var historyObj = JSON.parse(history);
		if (historyObj == null) {
			historyObj = [];
		}
		$('#grid').jsGrid({
			width : '100%',
			noDataContent : '履歴がありません',
			data : historyObj,
			fields : [ {
				title : '回した日時',
				name : 'time',
				type : 'text',
				width : 130
			}, {
				title : 'パズル名(サイズ)',
				name : 'type',
				type : 'text',
				width : 115
			}, {
				title : 'Lv',
				name : 'level',
				type : 'number',
				width : 30
			}, {
				title : 'リンク',
				name : 'link',
				type : 'text',
				width : 50
			}, ]
		});
	}
	var initRtaGridInfo = function() {
		rtaGridInfo.splice(0)
		$('#lbl_rta_status').text("まだ開始していません");
		var regulations = regMap[$('#sel_reg').val()];
		if (isCourseMode()){
			regulations = courseInfo.course;
		}
		for(var i = 0; i < regulations.length; i++) {
			rtaGridInfo.push({
				no : i + 1,
				type : ruleMap[regulations[i].type].name + '(' + regulations[i].size + ')' ,
				level : "",
				link : "",
				time : "",
			});
		}
	}

	var showRtaGrid = function() {
		$('#grid_rta').jsGrid({
			width : '100%',
			noDataContent : 'まだ開始していません',
			data : rtaGridInfo,
			fields : [  {
				title : 'No.',
				name : 'no',
				type : 'number',
				width : 30
			}, {
				title : 'パズル名(サイズ)',
				name : 'type',
				type : 'text',
				width : 115
			}, {
				title : 'Lv',
				name : 'level',
				type : 'number',
				width : 30
			}, {
				title : 'LAP(s)',
				name : 'time',
				type : 'number',
				width : 55
			}, {
				title : '累計(s)',
				name : 'totaltime',
				type : 'number',
				width : 55
			}, {
				title : 'リンク',
				name : 'link',
				type : 'text',
				width : 40
			}, ]
		});
	}
	// jsgridはグリッドになってしまうとデータの形での再操作はできないらしい
	// しかたないので、グリッドはプレゼンテーション専用としアイテムだけ自前で持つ
	var courseGridInfo = [];

	var initCourseGridInfo = function() {
		courseGridInfo.splice(0);
	}

	var showCourseGrid = function() {
		for(var i = 0; i < courseGridInfo.length; i++) {
			courseGridInfo[i].no = i + 1;
			courseGridInfo[i].up = i == 0 ? '' : '<button type="button" class="up" value="' + i + '">↑</button>';
			courseGridInfo[i].down = i == courseGridInfo.length - 1 ? '' : '<button type="button" class="down" value="' + i + '">↓</button>';
			courseGridInfo[i].del = '<button type="button" class="del" value="' + i + '">×</button>';
		}
		$('#grid_course').jsGrid({
			width : '100%',
			noDataContent : 'まだ追加されていません',
			data : courseGridInfo,
			fields : [  {
				title : 'No.',
				name : 'no',
				type : 'number',
				width : 30
			}, {
				title : 'パズル名',
				name : 'pname',
				type : 'text',
				width : 115
			}, {
				title : 'サイズ',
				name : 'size',
				type : 'text',
				width : 55
			}, {
				title : '',
				name : 'up',
				type : 'text',
				width : 30
			}, {
				title : '',
				name : 'down',
				type : 'text',
				width : 30
			}, {
				title : '',
				name : 'del',
				type : '',
				width : 30
			}, {
				title : '',
				name : 'type',
				type : '',
				width : 0
			}, ]
		});
		$("#grid_course").jsGrid("fieldOption", "type", "visible", false);
        $('#lbl_course_already').hide();
        $('#a_course').hide();
        $('#tweetbtn').hide();
	}

	// コース追加ボタン
	$('#btn_submit_course').click(function() {
		var no = courseGridInfo.length + 1;
		if (no > 15){
			alert('追加できるパズルは最大15個までです。')
			return;
		}
		var type = $('#sel_type').val();
		if (type == 'simplegako'){
			alert('申し訳ございません。そのパズルは追加できません。')
			return;
		}
		courseGridInfo.push({
			pname:ruleMap[type].name,
			size:$('#sel_size').val(),
			type:type,
		});
		showCourseGrid();
	});

	// ↑
    $('body').on('click', '.up' , function(e) {
    	var idx = parseInt($(e.target).val() ,10);
    	var wk = courseGridInfo[idx - 1];
    	courseGridInfo[idx - 1] = courseGridInfo[idx]
    	courseGridInfo[idx] = wk;
		showCourseGrid();
    });
	// ↓
    $('body').on('click', '.down' , function(e) {
    	var idx = parseInt($(e.target).val() ,10);
    	var wk = courseGridInfo[idx + 1];
    	courseGridInfo[idx + 1] = courseGridInfo[idx]
    	courseGridInfo[idx] = wk;
		showCourseGrid();
    });
	// ×
    $('body').on('click', '.del' , function(e) {
    	var idx = parseInt($(e.target).val() ,10);
    	courseGridInfo.splice( idx, 1 ) ;
		showCourseGrid();
    });

	// コース作成完了ボタン
	$('#btn_course_finish').click(function() {
		if ($('#edt_course_name').val() == ''){
			alert('コース名を設定してください。')
			$('#edt_course_name').focus();
			return;
		}
		if (toHashTag($('#edt_course_name').val()) == ''){
			alert('コース名は英数字・ひらがな・カタカナ・漢字などを使用してください。')
			$('#edt_course_name').focus();
			return;
		}
		if (courseGridInfo.length == 0){
			alert('パズルを最低1つ追加してください。')
			return;
		}
		var param = {};
		param.name = $('#edt_course_name').val();
		param.course = [];
		for(var i = 0; i < courseGridInfo.length; i++) {
			param.course.push({type:courseGridInfo[i].type,size:courseGridInfo[i].size});
		}
		var text = JSON.stringify(param);
        var url = location.href.split('?')[0] + '?p=' + zipEncode(text);
        $('#lbl_course_already').show();
        $('#a_course').attr('href',url);
        $('#a_course').html(url);
        $('#a_course').show();
		var tweetTxt = '新コース「'
				+ param.name
				+ '」を作成！RTAに挑戦しましょう！';
		var befSplitted = $('#tweetbtn').attr('href').split("?");
		var splitted = befSplitted[1].split("&");
		if (befSplitted.length == 3){
			befSplitted.splice(2,1);
		}
		splitted[0] = 'hashtags=ペンパガチャ,'
			+ encodeURIComponent(toHashTag(param.name) + 'RTA');
		splitted[1] = 'text='
				+ encodeURIComponent(tweetTxt);
		splitted[3] = 'url=' + encodeURIComponent(url);
		befSplitted[1] = splitted.join('&')
		$('#tweetbtn').attr('href', befSplitted.join('?'))
		$('#tweetbtn').show();
	});

    // まずはパラメータのチェック
	var urlParam = location.search.substring(1);
	if (urlParam != ''){
		try {
			// パラメータがあれば特殊ルート
			var param = urlParam.split('&')[0].split('=')[1];
	    	// pを復号
	    	var ab = atob(param);
	    	ab = Uint8Array.from(ab.split(""), e => e.charCodeAt(0));
	    	var inflate = new Zlib.RawInflate(ab);
	    	var plain = inflate.decompress();
	    	var rtext = new TextDecoder().decode(plain);
	    	courseInfo = JSON.parse(rtext);
			$('#tweetbtn').hide();
			$('#edt_if').hide();
			$('#loading').hide();
			$('#a_return').show();
			showhide();
		} catch (e) {
			$('body').html('申し訳ございません。パラメータエラーが発生したようです。問題が解消しない場合<a href="https://twitter.com/3892myamya/" target="_blank">@3892myamya</a>までお問合せください。');
		} finally {
			return;
		}
	}

	// 保存された条件があれば読みだす
	var cond = localStorage.getItem('condsudoku');
	var condObj = JSON.parse(cond);
	if (condObj != null) {
		if (condObj.mode === undefined) {
			$('#sel_mode').val('normal');
		} else {
			$('#sel_mode').val(condObj.mode);
		}
		if (condObj.type === undefined) {
			$('#sel_type').val('sudoku');
		} else {
			$('#sel_type').val(condObj.type);
		}
		if (condObj.pattern === undefined) {
			$('#sel_pattern').val(1);
		} else {
			$('#sel_pattern').val(condObj.pattern);
		}
		if (condObj.size === undefined) {
			$('#sel_size').val(4);
		} else {
			$('#sel_size').val(condObj.size);
		}
		if (condObj.reg === undefined) {
			$('#sel_reg').val('yajilin');
		} else {
			$('#sel_reg').val(condObj.reg);
		}
		showGrid();
	} else {
		// 初期条件。
		$('#sel_mode').val('normal');
		$('#sel_type').val('sudoku');
		$('#sel_pattern').val(1);
		$('#sel_size').val(4);
		$('#sel_reg').val('yajilin');
	}
	$('#tweetbtn').hide();
	$('#edt_if').hide();
	$('#a_return').hide();
	$('#loading').hide();
	showhide();
});
